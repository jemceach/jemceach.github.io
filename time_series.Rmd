---
output: 
  html_document:
    highlight: zenburn
    df_print: paged
    code_folding: hide
---

<div class="fluid-row" id="TOC">
  <b>Time Series Tutorial</b>
  <ul>
    <li>01 <a href="#01" onclick="fadeInOut()"> Getting Started</a></li>
    <li>02 <a href="#02" onclick="fadeInOut()"> Data Exploration</a></li>
    <li>03 <a href="#03" onclick="fadeInOut()"> Time Series Analysis</a></li>
    <li>04 <a href="#04" onclick="fadeInOut()"> Forecasting</a></li>
  <ul>
</div>

<a class="anchor" id="01"></a>

<div class="fluid-row" id="header" style="padding-top: 10%;">
<h1>Time-Series Forecasting</h1>

Welcome to how2 on initial data analysis and time series fundementals. Added bonuses include formatting tips, gg-hacking, and navigating the <a href="https://cran.r-project.org/web/packages/forecast/forecast.pdf" target="_blank"> `forecast` </a> package. 

This tutorial is modified from an academic <a href="https://github.com/jemceach/predictive-analytics/tree/master/Project_One" target="_blank"> project</a> designed for students to develop a one-month forecast for cash withdrawals from several ATM machines. For replication purposes, data is publically available in my github <a href="https://github.com/jemceach/jemceach.github.io/blob/master/projects/data/ATM_Data.xlsx" target="_blank">repository</a>. 

</div>

<div class="fluid-row" id="header" style="padding-top: 2%;">

### Getting Started 
 
#### Load Packages

Let's get started! To begin, the following packages should be installed and loaded in R:

```{r libraries, echo = T, message=F, warning=F, tidy=T, error=F, class.source='fold-show'}
# Read XLSX file
library(readxl)

# Data manipulation 
library(dplyr); library(tidyr); library(tibble) 

# Data visualization / formatting
library(ggplot2); library(ggfortify); library(grid); library(gridExtra); 
library(extrafont); library(default); library(plotly); library(fontawesome)

# Timeseries / Forecasting
library(stats); library(imputeTS); library(forecast)
```

#### Formatting

As you'll soon find out, I `r fa("heart", fill = "#da77c6")` formatting and efficiency. As a result, I have gotten into the habit of programming as much of my format in advance when working on a new project. I find this practice to be super helpful for consistency and brevity in my code. 

For this tutorial, I set my go-to R code chunk options with the `opts_chunk` function from the `knitr` package. I also and the `default` package to specify new, default arguments for plotting functions.

```{r formatting, tidy=F, class.source='fold-show'}
# Options for R code chunks
knitr::opts_chunk$set(
  echo = T, message=F, warning=F, error=F, comment=NA,
  fig.width=10, fig.height = 3, out.width='100%'
  )

# Font options
## Create font option for par and gpar functions
windowsFonts(FGB = windowsFont("Franklin Gothic Book"))
## Load font option for ggplots
extrafont::loadfonts(quiet = T)

# Quick colors
grey = "#868b8c"; ggdark = "#7F7F7F"; black = "#000000"; 
eggshell = "#d8d2c2"; gold = "#c1b176"; red = "#a74141" 

# Set base font family for all ggplot-text elements
default::default(theme_dark) <- list(
  base_family = "Franklin Gothic Book"
  )

# Set default augments for custom ggplot2 theme tweeks
default::default(theme) <- list(
  axis.text.x = element_text(size=8, angle = 0, hjust = NULL),
  axis.text.y = element_text(size=8, angle = 90, hjust = 1),
  plot.title = element_text(color=black, size=10, face="bold"),
  legend.title = element_text(size=8, color=grey, face="bold"),
  strip.text.x = element_text(size = 8, face="bold"),
  panel.spacing = unit(2, "lines")
  )

# Scale currency
default(scale_y_continuous)<-list(
  labels = scales::dollar_format(), breaks = c(0, 75, 150)
  )
```

#### Data Preparation

The `atm_data` is stored as a long dataframe with 3 columns: `DATE`, `ATM`, and `Cash` (in hundreds of dollars). Our task is to come up with several, one-month forecasts, so let's first prepare the data by separating the ATM machines into a wide format. Then, we can inspect the structure of the new dataframe. 

```{r prep, class.source='fold-show'}
# Load Data
atm_data <- readxl::read_excel("./projects/data/ATM_Data.xlsx") 

# Clean dataframe
atm <- atm_data %>% 
  ## Create wide dataframe
  tidyr::spread(ATM, Cash) %>%
  ## Arrange date in ascending order
  dplyr::arrange(DATE) 
```

Our data is now structured into 4 columns and contains one year (365 observation) of dates and withdrawals.

```{r str, class.source='fold-show'}
str(atm)
```


</div>


<a class="anchor" id="02"></a>

<div class="fluid-row" id="header" style="padding-top: 10%;">

### Data Exploration 

Before modeling the data, we need to understand the information we're working with. We can do so with summary statistic and graphic visualizations of the ATM data. 

#### Summary Statistics

Using the `summary` function, we can quickly confirm that our `DATE` variable ranges one year, from 01 May 2009 to 30 April 2010. ATM2 contains one missing observation and the max value on ATM3, compared to the other quartiles, suggests a potential outlier in the data. 

```{r, class.source='fold-show'}
summary(atm)
```

</div>

#### Visualization 

Graphs are useful tools in the exploration process. Histograms allow us to visualize distrubtion of `ATM` cash withdrawals and scatterplots enable us to better understand the relationship between `DATE` and `ATM`.  

```{r class.source='fold-hide'}
p_hist <- atm %>% 
  ## Gather observations for facet plot
  tidyr::gather(key=ATM, value=Cash, ATM1,ATM2, ATM3) %>%
  ## Plot atms as histogram with ggplot2 package
  ggplot(aes(Cash)) +
    # Create scatterplots
    geom_histogram(color=gold, fill=eggshell, alpha=.8) +
    # Wrap panels based on ATM
    facet_wrap(~ATM, scales='free', nrow=1) +
    # Modify labels
    labs(title="ATM Histogram",y="", x="")+
    scale_x_continuous(labels = scales::dollar_format())+
    # Call theme components
    theme_dark()+
    theme()

plotly::ggplotly(p_hist) 
```

We can see from the histograms that all ATM series contain are skewed left. The distribution of ATM1 and ATM3 appear bimodal, whereas ATM2 shows multimodal peaks. There is also an extreme outlier in ATM3 that we will address later on.

```{r class.source='fold-hide'}
# plot atms as scatterplot
p_scatter <- atm %>% 
  ## Gather observations for facet plot
  tidyr::gather(key=ATM, value=Cash, ATM1,ATM2, ATM3) %>%
  ## Plot with ggplot2 package 
  ggplot(aes(DATE, Cash)) +
    ## Create scatterplots
    geom_jitter(size=1, color=eggshell, alpha=.8) +
    ## Plot regression line to see patterns
    geom_smooth(method="loess", size=1.25, color=gold) +
    ## Wrap panels based on ATM
    facet_wrap(~ATM, scales='free', nrow=1) +
    ## Modify labels
    labs(title="ATM Scatterplot",x="", y="")+
    scale_y_continuous() +
    ## Call theme components
    theme_dark()+
    theme()

plotly::ggplotly(p_scatter)
```

ATM1 and ATM3 show similar non-linear trends, suggestive of a potential trend within the timeseries. The transaction on Feb 9 2010 for ATM3 stands out as a clear outlier to the typical pattern exhibited by the machine. ATM2 appears to follow a negative, linear trend until Februrary 2010, where the withdrawals begin to increase. 


<a class="anchor" id="03"></a>
<div class="fluid-row" id="header" style="padding-top: 10%;">

### Time Series Analysis

We will next create a time series from our data and examine its characteristics.  

#### Creating Time Series Objects

Using the `stats` package, we can coerce the ATM dataframe into a time series at a weekly frequency. This frequency makes the most sense as we have one year of data and our goal is to forecast one month of withdrawals. The time series plot below show high weekly variance as suspected in from the scatterplots above. 

```{r class.source='fold-show', fig.height=4}
# Set outlier in ATM4 to NA for imputation 
atm$ATM3[which.max(atm$ATM3)] <- NA

# Create TS object with weekly frequency (with NA values)   
atm_ts_withNA <- dplyr::select(atm, -DATE) %>% 
  stats::ts(start=c(1), frequency = 7, class="ts")

# impute missing values with series mean 
atm_ts_imp <- atm_ts_withNA %>% imputeTS::na_mean()

# Update theme for TS plots 
default(theme)<-list(legend.position = "none", 
                     panel.spacing = unit(1, "lines"), 
                     strip.placement = "outside")



# Autoplot TS with facet wrap
p_weekly <- ggplot2::autoplot(atm_ts_imp, facet=T, size=.5, alpha=.5, color=black) +
  labs(title = "Daily ATM Withdrawals by Week", x="", y="")+
  scale_y_continuous()+
  theme_dark()+ 
  theme()

#ggplotly(p_weekly)
#saveRDS(p_weekly, file="./projects/load/p_weekly.RDS")

rds<-readRDS("./projects/load/p_weekly.RDS")
ggplotly(rds)
```


<br>

In the code above, the missing value in ATM2 and extreme outlier in ATM3 were both substituted with the mean series value.  We can visualize the imputation process using `plotNA.imputations` function from the <a href="https://cran.r-project.org/web/packages/imputeTS/imputeTS.pdf" target=_blank">`imputeTS`</a> package. The plot below uses this function along with some custom formatting to hone in on the two changes made to the ATM series. This package also contains additional functions to view the gapsize and distribution of missing values. These features can be helpful for timeseries with many missing values.

```{r}
# Formatting Function: Fill rectange to match ggplot dark theme 
plt_dark_theme=function() do.call(rect,as.list(c(par()$usr[c(1,3,2,4)],col=ggdark)))

# Initiate layout for NA plots
graphics::layout(mat = matrix(c(1, 2), nrow = 1, ncol = 2), heights = c(1, 1), widths = c(1, 1))

# Set Graphical Parameters
par(family="FGB", col=black, lwd=2.5, cex=.75, oma=c(0,0,2,0))

#Visualize Imputed Values
imputeTS::plotNA.imputations(
  atm_ts_withNA[,2], atm_ts_imp[,2], 
  xlim = c(20,30), ylim=c(0,180),
  main = "ATM2", xlab="Day", ylab="Cash",
  panel.first=plt_dark_theme(),
  colWithNA=eggshell,
  colWithImputations=red,
  legend=F
  )

# Set Graphical Parameters
par(new=T, family="FGB", col=black, lwd=2.5, cex=.75, oma=c(0,0,2,0))

#Visualize Imputed Values
imputeTS::plotNA.imputations(
  atm_ts_withNA[,3], atm_ts_imp[,3], 
  xlim = c(36,46), ylim=c(0,180),
  main = "ATM3", xlab="Day", ylab="Cash",
  panel.first=plt_dark_theme(),
  colWithNA=eggshell,
  colWithImputations=red,
  legend=F
  )

# Add title to plot margins
mtext("Visualization of Imputed Values", outer = T, cex = 1, font=2, family="FGB")
```

#### Seasonality

```{r, fig.height=4}
# Subseries plots
ss_plot1 <- forecast::ggsubseriesplot(x=atm_ts_imp[,1])
ss_plot2 <- forecast::ggsubseriesplot(x=atm_ts_imp[,2])
ss_plot3 <- forecast::ggsubseriesplot(x=atm_ts_imp[,3])

# Labeller: lookup table
wk_day <- c(
  `1.5` = "Sun", `2.5` = "Mon", `3.5` = "Tues", `4.5`= "Wed",  `5.5` = "Thurs", `6.5` = "Fri", `7.5` = "Sat"
  )
  
# Bind SS plot data to create manual facet wrap of multivariate series
ss_plots <- rbind(
  cbind(ss_plot1$data, series="ATM1"),
  cbind(ss_plot2$data, series="ATM2"), 
  cbind(ss_plot3$data, series="ATM3")
  ) %>%
  ggplot(aes(time,y, group = season))+
  geom_line(size=.5, alpha=.5, color=black)+
  geom_line(ggplot2::aes_(y = ~avg), col = eggshell, alpha=.75)+
  geom_vline(xintercept = 2:7, size=.25)+ 
  coord_cartesian(xlim = c(1.25,7.75))+
  scale_y_continuous()+
  facet_wrap(~series, nrow=3, scales = "free_y", strip.position = "right")+
  scale_x_continuous(breaks = c(1.5:7.5), labels = wk_day)+
  theme_dark()+
  theme(axis.title.y = element_blank(), 
        axis.ticks.x = element_blank(),
        panel.spacing = unit(1, "lines"), strip.placement = "outside")+
  labs(x="", title="Subseries Plot")

ggplotly(ss_plots)
```

The 

#### Autocorrelation 

We can use ACF plots to vizualize autocorrelation within each time series. All three ACF plots show a large, positive lag beginning at `r7`, which slowly decreases over a multiple of 7. These lags are indicative of a strong, weekly trend, especially for ATM1 and ATM3. 

```{r class.source='fold-show'}
# Generate ACF data
ACF1 <- forecast::ggAcf(atm_ts_imp[,1], size=1, lag=52)
ACF2 <- forecast::ggAcf(atm_ts_imp[,2], size=1, lag=52)
ACF3 <- forecast::ggAcf(atm_ts_imp[,3], size=1, lag=52)

# Bind ACF data
ACF_all <- rbind(
  cbind(ACF1$data, series="ATM1"), 
  cbind(ACF2$data, series="ATM2"), 
  cbind(ACF3$data, series="ATM3")
  ) 

# Table view: First 7 lags
ACF_all %>%
  select(lag, Freq, series) %>% 
  as.data.frame() %>% 
  filter(lag < 8) %>%
  mutate(series = as.character(series),
         Freq = round(Freq, 2)) %>% 
  spread(key=lag, value=Freq) %>%
  rename_if(is.numeric, list(~ paste0("r", .)))
```

The plots also show a large, negative lag pattern, which begins at lag 2 and lag 5, and also decrease over a multiple of 7. The negative lags are strongest in the ATM2 series. These lags represent troughs which suggest the ATM withdrawals tend to be five and two days behind peaks in cash withdrawals. 


```{r}
# Confidence interval lines
ci <- qnorm((1 + 0.95) / 2) / sqrt(nrow(ACF_all))

# Facet plot ACF
p_ACF_all <- ACF_all %>%
  ggplot(aes(lag, Freq))+
  geom_hline(yintercept = 0, size=1, alpha=.8)+
  geom_hline(yintercept = c(-ci, ci), color = eggshell, linetype = "dashed", size=1, alpha=.8)+
  geom_segment(aes(x = lag, xend = lag, y = 0, yend = Freq), size=1, alpha=.8)+
  facet_wrap(~series, nrow=1)+
  theme_dark()+
  theme(axis.title.y = element_blank())+labs(x="\n\nlag")

ggplotly(p_ACF_all)
```

</div>


<a class="anchor" id="04"></a>
<div class="fluid-row" id="header" style="padding-top: 10%;">

### Forecasting


```{r}
gather_fc<- function(series1, series2, series3){
  rbind(
    cbind(as.data.frame(series1), series="ATM1"), 
    cbind(as.data.frame(series2), series="ATM2"), 
    cbind(as.data.frame(series3), series="ATM3")
  )  %>% 
  as.data.frame() %>%
  mutate(series = as.character(series))%>%
  rowid_to_column("Index") %>%
  group_by(series)%>%
  mutate(Index = seq(as.Date("2010/5/1"), as.Date("2010/5/31"), "days"))
}

plt_fc <- function(gather_fc, title){
  TS_all <- atm_ts_imp %>%
    as.data.frame() %>% 
    rowid_to_column("Index") %>%
    dplyr::mutate(Index = seq(as.Date("2009/5/1"), as.Date("2010/4/30"), "days")) %>%
    tidyr::gather(key="series", value="value", -Index)
  ggplot() + 
  geom_line(data=TS_all, aes(Index, value))+ 
  geom_ribbon(data=gather_fc, 
              aes(x=Index, ymin=`Lo 95`, ymax=`Hi 95`), fill='#e9e7de', alpha=.75)+
  geom_ribbon(data=gather_fc, 
              aes(x=Index, ymin=`Lo 80`, ymax=`Hi 80`), fill='#beb69b', alpha=.75)+
  geom_line(data=gather_fc, 
            aes(Index, `Point Forecast`), color="#938b6f", alpha=1)+ 
  scale_y_continuous()+
  labs(title=title)+
  facet_wrap(~series, nrow=3, scales = "fixed")+
  theme_dark()+
  theme(axis.title = element_blank(), 
        panel.spacing = unit(1, "lines"), strip.placement = "outside") 
}
```

#### Plots {.tabset}

##### STL

```{r fig.height=4}
STLF1 <- atm_ts_imp[,1] %>% stlf(h=31)  
STLF2 <- atm_ts_imp[,2] %>% stlf(h=31)  
STLF3 <- atm_ts_imp[,3] %>% stlf(h=31) 

STLF_all <- gather_fc(STLF1, STLF2, STLF3)

p_STLF <- plt_fc(STLF_all, title = "STLF Forecast")

ggplotly(p_STLF)
```

##### ETS

```{r fig.height=4}
ETS1 <- forecast::ets(atm_ts_imp[,1]) %>% forecast(h=31)
ETS2 <- forecast::ets(atm_ts_imp[,2]) %>% forecast(h=31) 
ETS3 <- forecast::ets(atm_ts_imp[,3]) %>% forecast(h=31)


ETS_all <- gather_fc(ETS1, ETS2, ETS3)

p_ETS <- plt_fc(ETS_all, title = "ETS Forecast")

ggplotly(p_ETS)
```

##### ARIMA

```{r fig.height=4}
ARIMA1 <- auto.arima(atm_ts_imp[,1]) %>% forecast(h=31)
ARIMA2 <- auto.arima(atm_ts_imp[,2]) %>% forecast(h=31) 
ARIMA3 <- auto.arima(atm_ts_imp[,3]) %>% forecast(h=31)


ARIMA_all <- gather_fc(ARIMA1, ARIMA2, ARIMA3)

p_ARIMA <- plt_fc(ARIMA_all, title = "ARIMA Forecast")

ggplotly(p_ARIMA)



```

